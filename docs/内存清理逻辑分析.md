# Mem Reduct 内存清理逻辑分析

## 项目概述

Mem Reduct 是一个轻量级的实时内存管理应用程序，用于监控和清理计算机上的系统内存。该项目使用Windows Native API（未公开的内部系统功能）来清理系统缓存。

## 核心清理机制

### 清理的内存区域（按位掩码定义）

Mem Reduct 支持清理以下8种内存区域：

| 掩码常量 | 值 | 描述 |
|---------|----|------|
| REDUCT_WORKING_SET | 0x01 | 工作集内存 |
| REDUCT_SYSTEM_FILE_CACHE | 0x02 | 系统文件缓存 |
| REDUCT_STANDBY_PRIORITY0_LIST | 0x04 | 待机优先级0列表 |
| REDUCT_STANDBY_LIST | 0x08 | 待机列表 |
| REDUCT_MODIFIED_LIST | 0x10 | 修改页面列表 |
| REDUCT_COMBINE_MEMORY_LISTS | 0x20 | 合并内存列表 |
| REDUCT_REGISTRY_CACHE | 0x40 | 注册表缓存 |
| REDUCT_MODIFIED_FILE_CACHE | 0x80 | 修改文件缓存 |

### 预定义的清理掩码组合

- **REDUCT_MASK_ALL**: 清理所有内存区域
- **REDUCT_MASK_DEFAULT**: 默认清理组合（工作集、系统文件缓存、待机优先级0列表、注册表缓存、合并内存列表、修改文件缓存）
- **REDUCT_MASK_FREEZES**: 可能导致系统冻结的区域组合（待机列表、修改页面列表）

## 清理触发方式

程序支持4种清理触发方式：

```c
typedef enum _CLEANUP_SOURCE_ENUM
{
    SOURCE_AUTO,     // 自动清理（基于内存使用率或时间间隔）
    SOURCE_MANUAL,   // 手动清理（用户点击清理按钮）
    SOURCE_HOTKEY,   // 热键触发
    SOURCE_CMDLINE   // 命令行触发
} CLEANUP_SOURCE_ENUM;
```

## 自动清理逻辑

自动清理在定时器回调函数 `_app_timercallback` 中实现：

```c
// 基于内存使用率的自动清理
if (mem_info.physical_memory.percent >= _app_getlimitvalue())
    is_clean = TRUE;

// 基于时间间隔的自动清理  
if (timestamp >= (_app_getintervalvalue() * 60))
    is_clean = TRUE;
```

## 核心清理函数 `_app_memoryclean`

### 1. 权限检查
- 检查程序是否以管理员权限运行
- 如果没有权限，尝试以管理员身份重新启动

### 2. 清理掩码配置
- 如果没有指定掩码，使用默认配置 `REDUCT_MASK_DEFAULT`
- 自动清理时可选排除可能导致系统冻结的区域

### 3. 具体清理操作

#### 工作集清理
```c
command = MemoryEmptyWorkingSets;
NtSetSystemInformation(SystemMemoryListInformation, &command, ...);
```

#### 系统文件缓存清理
```c
sfci.MinimumWorkingSet = MAXSIZE_T;
sfci.MaximumWorkingSet = MAXSIZE_T;
NtSetSystemInformation(SystemFileCacheInformationEx, &sfci, ...);
```

#### 待机列表清理
```c
command = MemoryPurgeStandbyList;  // 或 MemoryPurgeLowPriorityStandbyList
NtSetSystemInformation(SystemMemoryListInformation, &command, ...);
```

#### 卷缓存清理
- 遍历所有卷挂载点
- 对每个卷执行文件刷新操作

#### 注册表缓存清理（Windows 8.1+）
```c
NtSetSystemInformation(SystemRegistryReconciliationInformation, NULL, 0);
```

#### 内存列表合并（Windows 10+）
```c
NtSetSystemInformation(SystemCombinePhysicalMemoryInformation, &combine_info_ex, ...);
```

### 4. 清理结果统计
- 计算清理前后的内存使用差异
- 记录清理时间和释放的内存大小
- 显示清理结果通知

## 系统兼容性

- **Windows Vista+**: 支持所有主要功能
- **Windows 8.1+**: 支持注册表缓存清理
- **Windows 10+**: 支持内存列表合并功能

## 安全机制

- 所有清理操作都通过NT系统调用完成
- 每个操作都有错误处理和日志记录
- 自动清理可配置排除可能导致系统不稳定的操作

## 清理效果

根据项目文档，清理效果通常在10-50%之间，具体取决于系统当前的内存使用情况和缓存状态。

这种内存清理机制通过直接操作Windows内核内存管理结构来实现高效的内存释放，相比传统的应用程序内存清理更加深入系统层面。