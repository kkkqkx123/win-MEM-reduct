# Memreduct 右键菜单显示问题分析文档

## 1. 问题概述

通过截图分析，Memreduct 右键菜单中存在部分功能显示不全的问题：

- 某些菜单项仅显示为 `>` 符号，没有显示完整的子菜单标题
- 主要受影响的是清理区域和清理界限相关的子菜单

## 2. 代码分析

### 2.1 右键菜单构建位置

右键菜单的构建主要在 `src/tray_manager.c` 文件中的 `_app_tray_menu_create` 函数实现：

```c
// 创建右键菜单
static HMENU _app_tray_menu_create()
{
    HMENU hMainMenu = CreatePopupMenu();
    // ...
    // 创建清理内存子菜单
    HMENU hCleanSubMenu = CreatePopupMenu();
    _menu_append_check_item(hCleanSubMenu, IDM_WORKINGSET_CHK, _r_locale_getstring(IDS_WORKINGSET_CHK), 
                           (_app_config_get_clean_mask() & REDUCT_WORKING_SET) != 0);
    // ...
    // 添加子菜单到主菜单
    _r_menu_setitemtext(hMainMenu, IDM_TRAY_CLEAN, _r_locale_getstring(IDS_CLEAN));
    AppendMenu(hMainMenu, MF_POPUP, (UINT_PTR)hCleanSubMenu, NULL);
    // ...
    return hMainMenu;
}
```

### 2.2 菜单项定义

菜单项 ID 在 `src/resource.h` 中定义：

```c
// 右键菜单 ID
#define IDM_TRAY_SHOW                  167
#define IDM_TRAY_CLEAN                 168
#define IDM_TRAY_LIMIT                 169
#define IDM_TRAY_INTERVAL              170
// ...
#define IDM_WORKINGSET_CHK             198
#define IDM_WSL_CACHE_CLEAN_CHK        199
// ...

// 本地化字符串 ID
#define IDS_TRAY_SHOW                  12
#define IDS_TRAY_DISABLE               13
#define IDS_TRAY_POPUP_1               14
#define IDS_TRAY_POPUP_2               15
#define IDS_TRAY_POPUP_3               16
#define IDS_CLEAN                      17
// ...
```

### 2.3 本地化字符串资源

在 `bin/i18n/Chinese (Simplified).ini` 文件中，所有必要的本地化字符串都已定义：

```ini
IDS_TRAY_SHOW=显示/隐藏
IDS_TRAY_DISABLE=禁用
IDS_TRAY_POPUP_1=清理区域
IDS_TRAY_POPUP_2=清理界限
IDS_TRAY_POPUP_3=清理间隔
IDS_CLEAN=清理内存
```

### 2.4 动态菜单项生成

在 `src/ui_utils.c` 中，`_app_generate_menu` 函数负责动态生成子菜单项：

```c
// 生成清理界限和时间间隔子菜单
void _app_generate_menu(HMENU hMenu, const TCHAR *szFormat, DWORD_PTR *pdwIDs, 
                       DWORD_PTR dwCheckID, DWORD dwValue, UINT uSize, BOOL bZero)
{
    // ...
    // 使用本地化字符串设置子菜单文本
    TCHAR szText[64];
    _stprintf(szText, szFormat, dwValue);
    _r_menu_setitemtext(hMenu, pdwIDs[index], szText);
    // ...
}
```

## 3. 问题原因

经过深入分析，右键菜单显示不全问题的根本原因在于：

1. **子菜单标题被错误覆盖**：在`src/ui_utils.c`文件的`_app_generate_menu`函数中，错误地调用了`_r_menu_setitemtext (hsubmenu, 0, TRUE, _r_locale_getstring (IDS_TRAY_DISABLE));`，这会将子菜单的第一个菜单项（位置0）的文本设置为"禁用"，而不是设置子菜单标题。

2. **子菜单标题设置位置错误**：子菜单标题应该在`src/tray_manager.c`文件的`_app_tray_menu_create`函数中正确设置，而不是在`_app_generate_menu`函数中设置。

3. **正确的本地化字符串已定义**：在`bin/i18n/Chinese (Simplified).ini`文件中，已经定义了正确的子菜单标题字符串：
   - `IDS_TRAY_POPUP_1="清理区域"`
   - `IDS_TRAY_POPUP_2="清理界限"`  
   - `IDS_TRAY_POPUP_3="清理间隔"`

4. **菜单结构正确**：资源文件中的菜单结构定义正确，三个子菜单的索引分别为0、1、2。

## 4. 解决方案

### 4.1 修复右键菜单创建函数

修改 `src/tray_manager.c` 中的 `_app_tray_menu_create` 函数，确保子菜单标题正确设置：

```c
// 修复后的代码
// 第二个子菜单（清理界限）
_r_menu_setitemtext (hsubmenu, 0, TRUE, _r_locale_getstring (IDS_TRAY_POPUP_2)); // 修复：使用IDS_TRAY_POPUP_2

// 第三个子菜单（清理间隔）
_r_menu_setitemtext (hsubmenu, 0, TRUE, _r_locale_getstring (IDS_TRAY_POPUP_3)); // 修复：使用IDS_TRAY_POPUP_3
```

### 4.2 验证子菜单结构

根据 `resource.rc` 文件中的菜单结构，确认三个子菜单的正确用途：
- 第一个子菜单：清理区域（IDS_TRAY_POPUP_1）
- 第二个子菜单：清理界限（IDS_TRAY_POPUP_2）
- 第三个子菜单：清理间隔（IDS_TRAY_POPUP_3）

### 4.3 检查动态菜单项生成

确保 `_app_generate_menu` 函数正确使用本地化字符串格式，特别是对于清理界限和时间间隔子菜单。

## 5. 总结

右键菜单显示不全的问题主要是由于子菜单标题设置不正确导致的。通过修复 `_app_tray_menu_create` 函数中 `AppendMenu` 的调用，确保将本地化字符串作为子菜单标题传递，可以解决这个问题。所有必要的本地化字符串资源已经正确定义在中文(简体)本地化文件中，只需要在代码中正确引用即可。

修复后，右键菜单应该正确显示所有子菜单标题，包括"清理区域"、"清理界限"和"清理间隔"。